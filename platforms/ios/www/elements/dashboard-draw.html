<link rel="import" href="../bower_components/polymer/polymer.html">
<script src="../bower_components/jquery/dist/jquery.min.js"></script>
<script src="../bower_components/highcharts/highcharts.js"></script>
<script src="../scripts/getDashboardData.js"></script>
<script src="../scripts/getVisualisationData.js"></script>
<script src="../scripts/getKettleData.js"></script>
<script src="../scripts/getWorkboardData.js"></script>
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html" />
<link rel="import" type="css" href="../css/whirlpool_loder.css" />
<dom-module id="dashboard-draw">

<template>
	<style>
			
		

	</style>
	<div id="container" style="height: 300px;width: 400px">
		
		<div id="loader" class="cssload-container" style="display:block">
			<div class="cssload-whirlpool"></div>
		</div>
	</div>
</template>
<script>
    var workboardData = []; //Will be used to store JSON data.
    var kettleData = [];  //Will be used to store JSON data.
    var visualData = []; //Will be used to store JSON data.
    var option = []; //Will be used for the high charts.
    var visualization;
    var workboardDataConfiguration = [];
    var decryptedData = [];
    var kettleResultset = [];		
    var visualisationConfiguration =[];
	var chartObj;

    Polymer({
        is:"dashboard-draw",
		properties:{
				localHeight:{
					type:Number,
					value:5
				},
				dataGsHeight:{
					type:Number,
					value:5,
					notify:true,
					reflectToAttribute:true
				},
				dataClass:{
					type:String,
					value:'grid-stack-item-content',
					readonly:true
				},
				configuration:{
					type:Object,
					value:function(){
						return {};
					}
				},
				heading:{
					type:String,
					value:'',
					
				},
				subHeading:{
					type:String,
					value:'',
					readonly:true
				},
				dataId:{
					type:String,
					value:''
				},
				data:{
					type:Object,
					value:function(){
						return {};
					},
					observer:'__dataChanged'
				}
		},
		ready: function() {
		    this.loadingStop();
		  },
        createDashboard:function(userId,workboard_id)
        {
            var self=this;
            self.loadingStart(); 
			$.when(
                    workboardData = getWorkboardData(userId,workboard_id),
                    visualData = getVisualisationData(userId,workboard_id),
                    kettleData = getKettleData(userId,workboard_id)
					
			).done(function(){
                     //self.loadingStop();
					
                 });
            $('#container').css("display","block");
            $("#container").find("paper-material").remove();
            self.createDashboard1();
        
        },
        createDashboard1:function()
        {    
          var self=this;
          $.each(workboardData.data,function(index,value)
          {
           	self.configuration=workboardData.data;
                this.dataId = index;         
				self.draw(index);
          }); 
        },
		resize:function(){
			if(typeof this.chartObj !== 'undefined' && Object.keys(this.chartObj).length){
				var chart= $(this.$.panelChart);
				this.chartObj.setSize(chart.width()-50,chart.height()-50);
				this.chartObj.reflow();
			}
		},
		draw: function(dataId){
			var self=this;
			//this.loadingStart();
			try{
				var visualization=visualData.data;
				if(kettleData.data.hasOwnProperty(dataId) && typeof(kettleData.data[dataId]) === 'object' && visualization.hasOwnProperty(dataId)  && typeof(visualization[dataId]) === 'object'){
					var options=this.normalize(visualization[dataId],this.customPreProcessor(kettleData.data[dataId].resultSet,this.configuration[dataId].configuration.columnInfo),dataId);
					
						if(typeof this.chartObj !== 'undefined' && Object.keys(this.chartObj).length) {
							this.chartObj.destroy();
						}
							console.log(options);
							chartObj=new Highcharts[visualization[dataId].configuration.chartType](options,function(){
								self.resize();
								self.loadingStop();
							});
							
				}
			}
			catch(e){
				console.error(e)
			}
		},		
		customPreProcessor:function(data,temp){
			var func=new Function('data',atob(temp));
			return func(data);
		},
		normalize:function(visualization,data,dataId){
			var result=visualization.configuration.result;
			result['title']={text:""};
			var div=document.createElement('paper-material');
			div.setAttribute("elevation","2");
			$(div).css("background-color","white");
			$(div).css("height","auto");                
			$(div).css("margin","10px");
			$(div).css("margin-bottom","20px");
			$(div).css("padding","5px");
			div.setAttribute("id","id"+dataId);
			var title = document.createElement("h3");
			div.appendChild(title);
			var container=document.getElementById("container");
			container.appendChild(div);
			var id ="id"+dataId;
			if(result.hasOwnProperty('chart')){
			  delete result.chart['renderTo'];
					result.chart.renderTo=id;
				}else{
				 result.chart={
				  renderTo: id,
				}
			  }
				result['credits']={"enabled": false};
				result["exporting"]={enabled:false};
				result['series']=data.series;
				if(data.hasOwnProperty('xAxisCategories') && data['xAxisCategories'].length){
					if(result.hasOwnProperty('xAxis')){
						result['xAxis'].categories=data['xAxisCategories'];
					}else{
						result['xAxis']={categories:data['xAxisCategories']};
					}
				}
				
				if(data.hasOwnProperty('subtitleText') && data['subtitleText'].length){
					if(result.hasOwnProperty('subtitle')){
						result['subtitle'].text=data['subtitleText'];
					}else{
						result['subtitle']={text:data['subtitleText']};
					}
				}
				return result;
		},


       loadingStart: function(){
           //console.log("Loader function called");
           //document.getElementById('loader').style.display="block";
           $("#loader").show();
       },
       loadingStop: function(){
           //console.log("Loader function stopped");
           //document.getElementById('loader').style.display="none";
           $("#loader").hide();
       }
    })
</script>
</dom-module>